"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("dateformat")),s=e(require("fs")),i=e(require("mkdirp")),a=e(require("path")),l=e(require("strip-ansi")),n=e(require("xmlbuilder"));const o=e=>{const t=[],s=[],i=[];return e.forEach(e=>{const a=[],l=[],n=[];e.testResults.forEach(e=>{"pending"===e.status?a.push(e):"failed"===e.status?l.push(e):n.push(e)}),a.length>0&&t.push({...e,testResults:a}),l.length>0&&s.push({...e,testResults:l}),n.length>0&&i.push({...e,testResults:n})}),[].concat(t,s,i)},r=e=>(e&&e.sort((e,t)=>t.perfStats.end-t.perfStats.start-(e.perfStats.end-e.perfStats.start)),e),u=e=>(e&&e.sort((e,t)=>e.perfStats.end-e.perfStats.start-(t.perfStats.end-t.perfStats.start)),e),c=e=>{if(e){const t=e.sort((e,t)=>h(e.testFilePath,t.testFilePath,!0));return t.forEach(e=>{e.testResults.sort((e,t)=>h(e.ancestorTitles.join(" "),t.ancestorTitles.join(" "),!0)),e.testResults.sort((e,t)=>h(e.title,t.title,!0))}),t}return e},d=e=>{if(e){const t=e.sort((e,t)=>h(e.testFilePath,t.testFilePath));return t.forEach(e=>{e.testResults.sort((e,t)=>h(e.ancestorTitles.join(" "),t.ancestorTitles.join(" "))),e.testResults.sort((e,t)=>h(e.title,t.title))}),t}return e},h=(e,t,s=!1)=>!s&&e<t||s&&e>t?-1:!s&&e>t||s&&e<t?1:0;class g{constructor(e,t,s,i){this.testData=e,this.jestConfig=s,this.consoleLogList=i,this.setupConfig(t)}async generate(){try{const e=await this.renderTestReport(),t=this.replaceRootDirInPath(this.jestConfig?this.jestConfig.rootDir:"",this.getConfigValue("outputPath"));return await i(a.dirname(t)),this.getConfigValue("append")?await this.appendToFile(t,e.toString()):await s.writeFileSync(t,e.toString()),this.logMessage("success",`Report generated (${t})`),e}catch(e){this.logMessage("error",e)}}async renderTestReport(){const e=await this.renderTestReportContent();if(this.getConfigValue("boilerplate")){return(await s.readFileSync(this.getConfigValue("boilerplate"),"utf8")).replace("{jesthtmlreporter-content}",e&&e.toString())}const t=n.create({html:{}}),i=t.ele("head");i.ele("meta",{charset:"utf-8"}),i.ele("title",{},this.getConfigValue("pageTitle"));let l=a.join(__dirname,`../style/${this.getConfigValue("theme")}.css`);this.getConfigValue("styleOverridePath")&&(l=this.getConfigValue("styleOverridePath"));if(!this.getConfigValue("useCssFile")&&!this.getConfigValue("styleOverridePath")){const e=await s.readFileSync(l,"utf8");i.raw(`<style type="text/css">${e}</style>`)}else i.ele("link",{rel:"stylesheet",type:"text/css",href:l});const o=t.ele("body");return e&&o.raw(e.toString()),this.getConfigValue("customScriptPath")&&o.raw(`<script src="${this.getConfigValue("customScriptPath")}"><\/script>`),t}renderTestSuiteInfo(e,t){const s=e.ele("div",{class:"suite-info"});s.ele("div",{class:"suite-path"},t.testFilePath);const i=(t.perfStats.end-t.perfStats.start)/1e3;s.ele("div",{class:"suite-time"+(i>this.getConfigValue("executionTimeWarningThreshold")?" warn":"")},i+"s")}renderSuiteFailure(e,t,s){const i=e.ele("div",{id:"suite-"+(s+1),class:"suite-container"});this.renderTestSuiteInfo(i,t);i.ele("div",{class:"suite-tests"}).ele("div",{class:"test-result failed"}).ele("div",{class:"failureMessages suiteFailure"}," ").ele("pre",{class:"failureMsg"},l(t.failureMessage))}async renderTestReportContent(){try{if(!this.testData||0===Object.entries(this.testData).length)throw Error("No test data provided");const e=n.begin().element("div",{id:"jesthtml-content"}),s=e.ele("header");s.ele("h1",{id:"title"},this.getConfigValue("pageTitle"));const i=this.getConfigValue("logo");i&&s.ele("img",{id:"logo",src:i});const a=e.ele("div",{id:"metadata-container"});if(this.testData.startTime&&!isNaN(this.testData.startTime)){const e=new Date(this.testData.startTime);if(e){const s=t(e,this.getConfigValue("dateFormat"));a.ele("div",{id:"timestamp"},"Started: "+s)}}const h=a.ele("div",{id:"summary"}),g=h.ele("div",{id:"suite-summary"});g.ele("div",{class:"summary-total"},`Suites (${this.testData.numTotalTestSuites})`),g.ele("div",{class:"summary-passed"+(0===this.testData.numPassedTestSuites?" summary-empty":"")},this.testData.numPassedTestSuites+" passed"),g.ele("div",{class:"summary-failed"+(0===this.testData.numFailedTestSuites?" summary-empty":"")},this.testData.numFailedTestSuites+" failed"),g.ele("div",{class:"summary-pending"+(0===this.testData.numPendingTestSuites?" summary-empty":"")},this.testData.numPendingTestSuites+" pending"),this.testData.snapshot.unchecked>0&&this.getConfigValue("includeObsoleteSnapshots")&&g.ele("div",{class:"summary-obsolete-snapshots"},this.testData.snapshot.unchecked+" obsolete snapshots");const f=h.ele("div",{id:"test-summary"});f.ele("div",{class:"summary-total"},`Tests (${this.testData.numTotalTests})`),f.ele("div",{class:"summary-passed"+(0===this.testData.numPassedTests?" summary-empty":"")},this.testData.numPassedTests+" passed"),f.ele("div",{class:"summary-failed"+(0===this.testData.numFailedTests?" summary-empty":"")},this.testData.numFailedTests+" failed"),f.ele("div",{class:"summary-pending"+(0===this.testData.numPendingTests?" summary-empty":"")},this.testData.numPendingTests+" pending");const m=((e,t)=>{switch(t&&t.toLowerCase()){case"status":return o(e);case"executiondesc":return r(e);case"executionasc":return u(e);case"titledesc":return c(e);case"titleasc":return d(e);default:return e}})(this.testData.testResults,this.getConfigValue("sort")),p=this.getConfigValue("statusIgnoreFilter");let T=[];return p&&(T=p.replace(/\s/g,"").toLowerCase().split(",")),m&&m.map((t,s)=>{if(!t.testResults||t.testResults.length<=0)return void(t.failureMessage&&this.getConfigValue("includeSuiteFailure")&&this.renderSuiteFailure(e,t,s));const i=e.ele("div",{id:"suite-"+(s+1),class:"suite-container"});this.renderTestSuiteInfo(i,t);const a=i.ele("div",{class:"suite-tests"});t.testResults.filter(e=>!T.includes(e.status)).forEach(async e=>{const t=a.ele("div",{class:"test-result "+e.status}),s=t.ele("div",{class:"test-info"});if(s.ele("div",{class:"test-suitename"},e.ancestorTitles&&e.ancestorTitles.length>0?e.ancestorTitles.join(" > "):" "),s.ele("div",{class:"test-title"},e.title),s.ele("div",{class:"test-status"},e.status),s.ele("div",{class:"test-duration"},e.duration/1e3+"s"),e.failureMessages&&e.failureMessages.length>0&&this.getConfigValue("includeFailureMsg")){const s=t.ele("div",{class:"failureMessages"}," ");e.failureMessages.forEach(e=>{s.ele("pre",{class:"failureMsg"},l(e))})}}),this.consoleLogList&&this.consoleLogList.length>0&&this.getConfigValue("includeConsoleLog")&&this.renderSuiteConsoleLogs(t,i),t.snapshot.unchecked>0&&this.getConfigValue("includeObsoleteSnapshots")&&this.renderSuiteObsoleteSnapshots(i,t)}),e}catch(e){this.logMessage("error",e)}}renderSuiteConsoleLogs(e,t){const s=this.consoleLogList.find(t=>t.filePath===e.testFilePath);if(s&&s.logs.length>0){const e=t.ele("div",{class:"suite-consolelog"});e.ele("div",{class:"suite-consolelog-header"},"Console Log"),s.logs.forEach(t=>{const s=e.ele("div",{class:"suite-consolelog-item"});s.ele("pre",{class:"suite-consolelog-item-origin"},l(t.origin)),s.ele("pre",{class:"suite-consolelog-item-message"},l(t.message))})}}renderSuiteObsoleteSnapshots(e,t){const s=e.ele("div",{class:"suite-obsolete-snapshots"});s.ele("div",{class:"suite-obsolete-snapshots-header"},"Obsolete snapshots");s.ele("div",{class:"suite-obsolete-snapshots-item"}).ele("pre",{class:"suite-obsolete-snapshots-item-message"},t.snapshot.uncheckedKeys.join("\n"))}setupConfig(e){const{append:t,boilerplate:i,customScriptPath:l,dateFormat:n,executionTimeWarningThreshold:o,logo:r,includeConsoleLog:u,includeFailureMsg:c,includeSuiteFailure:d,includeObsoleteSnapshots:h,outputPath:g,pageTitle:f,theme:m,sort:p,statusIgnoreFilter:T,styleOverridePath:S,useCssFile:E}=e||{};this.config={append:{defaultValue:!1,environmentVariable:"JEST_HTML_REPORTER_APPEND",configValue:t},boilerplate:{defaultValue:null,environmentVariable:"JEST_HTML_REPORTER_BOILERPLATE",configValue:i},customScriptPath:{defaultValue:null,environmentVariable:"JEST_HTML_REPORTER_CUSTOM_SCRIPT_PATH",configValue:l},dateFormat:{defaultValue:"yyyy-mm-dd HH:MM:ss",environmentVariable:"JEST_HTML_REPORTER_DATE_FORMAT",configValue:n},executionTimeWarningThreshold:{defaultValue:5,environmentVariable:"JEST_HTML_REPORTER_EXECUTION_TIME_WARNING_THRESHOLD",configValue:o},logo:{defaultValue:null,environmentVariable:"JEST_HTML_REPORTER_LOGO",configValue:r},includeFailureMsg:{defaultValue:!1,environmentVariable:"JEST_HTML_REPORTER_INCLUDE_FAILURE_MSG",configValue:c},includeSuiteFailure:{defaultValue:!1,environmentVariable:"JEST_HTML_REPORTER_INCLUDE_SUITE_FAILURE",configValue:d},includeObsoleteSnapshots:{defaultValue:!1,environmentVariable:"JEST_HTML_REPORTER_INCLUDE_OBSOLETE_SNAPSHOTS",configValue:h},includeConsoleLog:{defaultValue:!1,environmentVariable:"JEST_HTML_REPORTER_INCLUDE_CONSOLE_LOG",configValue:u},outputPath:{defaultValue:a.join(process.cwd(),"test-report.html"),environmentVariable:"JEST_HTML_REPORTER_OUTPUT_PATH",configValue:g},pageTitle:{defaultValue:"Test Report",environmentVariable:"JEST_HTML_REPORTER_PAGE_TITLE",configValue:f},theme:{defaultValue:"defaultTheme",environmentVariable:"JEST_HTML_REPORTER_THEME",configValue:m},sort:{defaultValue:null,environmentVariable:"JEST_HTML_REPORTER_SORT",configValue:p},statusIgnoreFilter:{defaultValue:null,environmentVariable:"JEST_HTML_REPORTER_STATUS_FILTER",configValue:T},styleOverridePath:{defaultValue:null,environmentVariable:"JEST_HTML_REPORTER_STYLE_OVERRIDE_PATH",configValue:S},useCssFile:{defaultValue:!1,environmentVariable:"JEST_HTML_REPORTER_USE_CSS_FILE",configValue:E}};try{const e=s.readFileSync(a.join(process.cwd(),"jesthtmlreporter.config.json"),"utf8");if(e){const t=JSON.parse(e);for(const e of Object.keys(t))this.config[e]&&(this.config[e].configValue=t[e]);return this.config}}catch(e){}try{const e=s.readFileSync(a.join(process.cwd(),"package.json"),"utf8");if(e){const t=JSON.parse(e)["jest-html-reporter"];for(const e of Object.keys(t))this.config[e]&&(this.config[e].configValue=t[e]);return this.config}}catch(e){}}getConfigValue(e){const t=this.config[e];if(t)return process.env[t.environmentVariable]?process.env[t.environmentVariable]:t.configValue||t.defaultValue}async appendToFile(e,t){let i=t;const a=await s.readFileSync(e,"utf8");if(a){const l=/<body>(.*?)<\/body>/gm.exec(t);if(l){const[e]=l;i=e}let n=a;const o=/<\/body>/gm.exec(a),r=o?o.index:0;return n=[a.slice(0,r),i,a.slice(r)].join(""),s.writeFileSync(e,n)}return s.appendFileSync(e,i)}replaceRootDirInPath(e,t){return/^<rootDir>/.test(t)?a.resolve(e,a.normalize("./"+t.substr("<rootDir>".length))):t}logMessage(e="default",t){const s={default:"[37m%s[0m",success:"[32m%s[0m",error:"[31m%s[0m"},i=s[e]?s[e]:s.default,a="jest-html-reporter >> "+t;return void 0===process.env.JEST_WORKER_ID&&console.log(i,a),{logColor:i,logMsg:a}}}const f=(e,t,s,i)=>new g(e,t,s,i).generate();module.exports=function(e,t){const s=[];if(Object.prototype.hasOwnProperty.call(e,"testResults"))return f(e.testResults,t,e),e;this.onTestResult=(e,t)=>{t.console&&s.push({filePath:t.testFilePath,logs:t.console})},this.onRunComplete=(i,a)=>f(a,t,e,s)};
